# ============================================================================
# Deployment Pipeline — Synthia 4.2
# ============================================================================
# Production: Coolify (Docker Compose on VPS)
# Frontend:   Cloudflare Pages (static Vite build)
# ============================================================================
name: Deploy Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
          - restart

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Build Backend Docker Image ───────────────────────────────────────────
  build-backend:
    name: Build Backend Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
            ghcr.io/${{ github.repository }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Build Frontend (Vite static) ─────────────────────────────────────────
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache-dependency-path: frontend/package-lock.json

      - name: Install & Build
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 3

  # ── Deploy Backend to Coolify ────────────────────────────────────────────
  deploy-coolify:
    name: Deploy Backend → Coolify
    needs: build-backend
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ vars.COOLIFY_APP_URL }}
    steps:
      - name: Trigger Coolify deployment
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] && echo "✓ Deployed" || (echo "✗ Failed" && exit 1)

      - name: Health check
        run: |
          sleep 60
          APP_URL="${{ vars.COOLIFY_APP_URL }}"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${APP_URL}/health" --max-time 10 || echo "000")
            [ "$STATUS" = "200" ] && echo "✓ Healthy" && exit 0
            sleep 15
          done
          echo "✗ Health check failed" && exit 1

  # ── Deploy Frontend to Cloudflare Pages ──────────────────────────────────
  deploy-frontend-cf:
    name: Deploy Frontend → Cloudflare Pages
    needs: build-frontend
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist/ --project-name=synthia-frontend
